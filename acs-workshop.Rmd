---
title: "Loading and Manipulating Data in R"
output: 
  html_document:
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
ev <- TRUE
```

# Setup

Install the required package by
```{r eval=FALSE}
install.packages(c("acs", "ggplot2"))
```

Load into the namespace:
```{r message=FALSE, warning=FALSE}
library(acs)
```

Obtain Census API key from [here](http://api.census.gov/data/key_signup.html). Install the key on your system for all future sessions:

```{r eval=FALSE}
api.key.install("1596fcec45b7994ead5cd5d62a6542131df257f6")
```

# Loading ACS Data

* Lookup geography and ACS table:

    ```{r eval=ev, echo=FALSE}
geo.lookup(state="WA", county="*")
geo.lookup(state="WA", county="Ki")
geo.lookup(state="WA", county="King", county.subdivision = "Seattle")
geo.lookup(state="WA", county="King", county.subdivision = "*")
```

* Create a geography:

    ```{r eval=ev}
geo <- geo.make(state=53, county=35, tract="*", check = TRUE)
geo <- geo.make(state=53, county=c(33, 35, 53, 61), check=TRUE)
```

* Lookup ASC table:

    ```{r eval=ev, echo=FALSE}
acs.lookup(2015, span = 1, table.name = c("Income", "Poverty"), case.sensitive = FALSE)
acs.lookup(2015, span = 1, table.number = "B17002")
```

* Loading data:

    ```{r eval=ev}
dataset <- acs.fetch(endyear = 2015, span = 1, geography = geo, table.number = "B17002") 
dim(dataset)
head(dataset)
dataset <- acs.fetch(endyear = 2015, span = 1, geography = geo, table.number = "B17002", 
                     col.names="pretty") 
dataset
```

* Change column names

   ```{r eval=ev}
acs.colnames(dataset)
acs.colnames(dataset) <- gsub("Ratio of Income to Poverty Level in the Past 12 Months: ", "", acs.colnames(dataset))
dataset
```

# Manipulating and Visualizing ACS Data

* Various mathematic operations are defined on asc datasets. E.g create a dataset of shares:

    ```{r eval=ev}
shares <- divide.acs(dataset, dataset[,rep(1, ncol(dataset))])*100
acs.colnames(shares) <- acs.colnames(dataset)
```

* Sums over columns, rows or individual cells:

    ```{r eval=ev}
apply(dataset, 1, sum)
apply(dataset, 2, sum)
dataset[,2] + dataset[,3] + dataset[,4]
dataset[2,2] + dataset[3,2]
```

* Visualization:

    ```{r eval=ev}
plot(shares)
plot(shares[,2:ncol(shares)])
plot(dataset[,2:7], by = "acs.colnames", 
     labels = c("King", "Kitsap", "Pierce", "Sno"))
plot(sum(dataset[,1]))
```

* Adding rows/columns. Add a row of sums:

    ```{r eval=ev}
data.wsum <- rbind(dataset, apply(dataset, 1, sum))
```

* Converting to R matrices 

    Decompose into estimates and standard errors:
    
    ```{r eval=ev}
est <- estimate(data.wsum)
est
class(est)
se <- standard.error(data.wsum)
se
rownames(est) <- rownames(se) <- gsub(" County, Washington", "", rownames(est))
shest <- estimate(shares)
shse <- standard.error(shares)
rownames(shest) <- rownames(shse) <- rownames(est)[1:4]
```

* View with standard R graphics:

    ```{r eval=ev}
plot(est[,1], se[,1])
plot(est[2,2:ncol(est)], est[3,2:ncol(est)])
hist(est[5,2:ncol(est)])
```

* Fancy plots via `ggplot2`.
    * by variable:
    
        ```{r eval=ev}
library(ggplot2)
df <- melt(shest[,2:ncol(shest)])
head(df)
colnames(df)[1:2] <- c("County", "Variable")
g1 <- ggplot(df, aes(Variable, fill=County, weight=value)) + geom_bar(position="dodge") + 
  ylab("") + xlab("")
print(g1)
```

    * by county:
    
        ```{r eval=ev}
g2 <- ggplot(df, aes(County, fill=Variable, weight=value)) + geom_bar(position="dodge") + 
  ylab("") + xlab("")
print(g2)
```

* Save into a file
    * Estimates only:
    
        ```{r eval=FALSE}
write.csv(est, file="population_by_income.csv")
write.csv(t(est), file="population_by_income_transposed.csv")
```

    * Including 95% confidence intervals:
<!--qnorm(1-(1-0.90)/2)-->

        ```{r eval=FALSE}
output <- matrix(paste0(est, " (", 1.96*se, ")"), nrow=nrow(est))
head(output)
output <- matrix(paste0(popest, " (", round(1.96*popse, 2), ")"), nrow=nrow(popest),
                dimnames=dimnames(popest))
head(output)
write.csv(output, file="population_by_tenure_with_ci.csv")
```
    
    
# Manipulating R matrices and data frames

* Change rownames

    ```{r eval=ev}
tract.splits <- strsplit(rownames(popest), ", ")
head(tract.splits)
tract.splits <- sapply(tract.splits, "[[", 1)
tracts <- gsub("Census Tract ", "", tract.splits)
rownames(popest) <- tracts
rownames(popse) <- tracts
head(popest)
```

* Add ratio as a column

    ```{r eval=ev}
popest <- cbind(popest, estimate(ratio))
popse <- cbind(popse, standard.error(ratio))
head(popest)
```

* Add sum and average as last row

    ```{r eval=ev}
sums <- apply(popest[,1:3], 2, sum)
med <- median(popest[,'ratio'], na.rm=TRUE)
popest <- rbind(popest, c(sums, med))
popest <- round(popest,3)
colnames(popest)[ncol(popest)] <- "Renter/Owner"
head(popest)
```

* Remove Inf and NaNs

    ```{r eval=ev}
popest[is.infinite(popest) | is.na(popest)] <- 0
tail(popest)
```

* Save into a file
    * Estimates only:
    
        ```{r eval=FALSE}
write.csv(popest, file="population_by_tenure_nicer.csv")
```

    * Tracts as a column:
    
        ```{r eval=FALSE}
output <- cbind(rownames(popest), as.data.frame(popest)
colnames(output)[1] <- "Tract ID"
write.csv(output, file="population_final.csv", row.names=FALSE)
write.table(output, file="population_final.txt", row.names=FALSE, sep="\t")
```

# Functions

* Create a function to run the above steps for different county and different year. 
    * Store the code below into a new file:

        ```{r eval=ev}
popbytenure <- function(county, year = 2015, file.prefix = "population_by_tenure") {
    # create geography and load data
    geo <- geo.make(state = 53, county = county, tract = "*")
    pop <- acs.fetch(endyear = year, geography = geo, table.number = "B25008")
    acs.colnames(pop) <- c("Total", "Owner", "Renter")
    
    # create ratio
    ratio <- divide.acs(pop[,'Renter'], pop[,'Owner'])
    acs.colnames(ratio) <- 'ratio'
    
    # extract tract ids
    popest <- estimate(pop)
    tract.splits <- strsplit(rownames(popest), ", ")
    tract.splits <- sapply(tract.splits, "[[", 1)
    tracts <- gsub("Census Tract ", "", tract.splits)
    rownames(popest) <- tracts
    
    # combine pop and ratio, compute sum and median
    popest <- cbind(popest, estimate(ratio))
    sums <- apply(popest[,1:3], 2, sum)
    med <- median(popest[,'ratio'], na.rm=TRUE)
    popest <- round(rbind(popest, c(sums, med)), 3)
    
    # remove inf and NaN
    popest[is.infinite(popest) | is.na(popest)] <- 0
    
    # save
    output <- cbind(rownames(popest), as.data.frame(popest))
    colnames(output)[1] <- "Tract ID"
    file.name <- paste0(file.prefix, "_", year, "_", county, ".csv")
    write.csv(output, file=file.name, row.names=FALSE)
    cat("\nFile", file.name)
    return(nrow(output))
}
```

    * Create a loop that calls the above function with different values of the arguments:
    
        ```{r eval=FALSE}
for(year in c(2014, 2015)) {
    for (county in c(33, 53, 35, 61)) {
        nrec <- popbytenure(county, year=year)
        cat(" #tracts: ", nrec)
    }
}
```